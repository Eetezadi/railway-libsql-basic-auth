name: Build and Push libSQL

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    # Required for pushing to GHCR
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Repository Name
        # Converts "ghcr.io/Eetezadi/libsql-server" to lowercase
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Extract libSQL Version
        id: get_version
        run: |
          echo "--- DEBUG: Running sqld --version ---"
          # 1. Capture the raw output
          FULL_OUTPUT=$(docker run --rm ghcr.io/tursodatabase/libsql-server:latest /bin/sqld --version)
          echo "Raw output from container: '$FULL_OUTPUT'"

          # 2. Use a strict Regex to grab ONLY the numbers and dots
          # This ignore the word 'sqld' entirely by looking for the pattern X.Y.Z
          CLEAN_VER=$(echo "$FULL_OUTPUT" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          
          echo "Regex result (CLEAN_VER): '$CLEAN_VER'"

          # 3. Final safety check
          if [ -z "$CLEAN_VER" ]; then
            echo "⚠️ WARNING: Regex failed to find a version number. Defaulting to 'latest-build'."
            CLEAN_VER="latest-build"
          fi

          echo "LIBSQL_VER=$CLEAN_VER" >> $GITHUB_OUTPUT
          echo "Final Version Tag to be used: $CLEAN_VER"
          echo "---------------------------------------"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Tags the image with 'latest' and the specific libSQL version
          tags: |
            ghcr.io/${{ env.REPO_LC }}:latest
            ghcr.io/${{ env.REPO_LC }}:${{ steps.get_version.outputs.LIBSQL_VER }}
